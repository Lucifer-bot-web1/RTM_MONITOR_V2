{% extends "base.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
<link href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

<style>
    /* --- THEME: NETWORK OPS --- */
    :root {
        --bg-core: #050505;
        --bg-panel: rgba(10, 12, 16, 0.95);
        --border-color: rgba(0, 255, 242, 0.2);
        --accent-cyan: #00fff2;
        --text-mono: 'Courier New', monospace;
    }

    #topology-bg {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        background: var(--bg-core);
    }

    /* --- WIDGET STYLES --- */
    .grid-stack-item-content {
        background: var(--bg-panel);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; overflow: hidden;
    }

    .widget-header {
        padding: 8px 12px;
        background: rgba(0, 255, 242, 0.05);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        cursor: grab; user-select: none;
    }
    .widget-title { font-size: 11px; font-weight: bold; color: var(--accent-cyan); letter-spacing: 1px; }

    .widget-body {
        flex: 1; padding: 10px; overflow: hidden; position: relative;
    }

    /* --- TERMINAL --- */
    .terminal-container {
        display: flex; flex-direction: column; height: 100%;
        background: #000; font-family: var(--text-mono);
    }
    .term-controls {
        padding: 8px; border-bottom: 1px solid #333; display: flex; gap: 8px;
        background: #111;
    }
    .term-input {
        background: #000; border: 1px solid #444; color: #00fff2;
        padding: 4px 8px; flex: 1; font-family: inherit; font-size: 12px;
    }
    .term-btn {
        background: #222; color: white; border: 1px solid #444;
        padding: 4px 12px; cursor: pointer; font-size: 10px; font-weight: bold;
    }
    .term-btn:hover { background: var(--accent-cyan); color: black; }

    .term-output {
        flex: 1; overflow-y: auto; padding: 10px; color: #ccc; font-size: 11px;
        display: flex; flex-direction: column; gap: 2px;
    }
    .line-reply { color: #2ecc71; }
    .line-error { color: #ff4757; }

    /* --- CLICKABLE STATUS CARDS --- */
    .status-card {
        display: flex; align-items: center; justify-content: space-between; height: 100%; padding: 0 10px;
        cursor: pointer; transition: 0.2s;
    }
    .status-card:hover { background: rgba(0, 255, 242, 0.05); }

    .val-huge { font-size: 32px; font-weight: bold; color: white; }
    .blink-red { animation: blink 1s infinite; color: #ff4757; }
    @keyframes blink { 50% { opacity: 0.5; } }

    /* --- POPUP MODAL (LIST) --- */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 9999; backdrop-filter: blur(5px);
        align-items: center; justify-content: center;
    }
    .modal-box {
        width: 500px; background: #0b0c0e; border: 1px solid var(--accent-cyan);
        box-shadow: 0 0 30px rgba(0, 255, 242, 0.2); border-radius: 4px;
        display: flex; flex-direction: column;
    }
    .modal-header {
        padding: 15px; border-bottom: 1px solid #333;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0, 255, 242, 0.05);
    }
    .modal-title { color: var(--accent-cyan); font-weight: bold; letter-spacing: 1px; }
    .modal-close { background: none; border: none; color: #ff4757; cursor: pointer; font-size: 16px; }

    /* SCROLLABLE LIST */
    .modal-body {
        max-height: 400px; /* Limits height */
        overflow-y: auto;  /* Enables scroll */
        padding: 10px;
    }
    .device-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px; border-bottom: 1px solid #222; color: #ccc; font-size: 12px; font-family: var(--text-mono);
    }
    .device-item:hover { background: #151515; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }

</style>

<div id="topology-bg"></div>

<div style="padding: 10px 20px; background: rgba(0,0,0,0.8); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
    <div style="color: var(--accent-cyan); font-weight: bold; font-family: var(--text-mono);">
        <i class="fa-solid fa-network-wired"></i> RTM OPERATIONS CENTER
    </div>
    <button onclick="saveLayout()" class="term-btn"><i class="fa-solid fa-save"></i> SAVE LAYOUT</button>
</div>

<div class="grid-stack">

    <div class="grid-stack-item" gs-x="0" gs-y="0" gs-w="3" gs-h="2">
        <div class="grid-stack-item-content">
            <div class="widget-header"><span class="widget-title">ACTIVE NODES</span><i class="fa-solid fa-grip-lines"></i></div>
            <div class="widget-body" style="padding:0;">
                <div class="status-card" onclick="openDeviceList('UP')">
                    <div><div class="val-huge" style="color:#2ecc71;">{{ up }}</div><div style="font-size:9px; color:#888;">OPERATIONAL (CLICK TO VIEW)</div></div>
                    <i class="fa-solid fa-wifi" style="font-size:24px; color:#2ecc71;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="3" gs-y="0" gs-w="3" gs-h="2">
        <div class="grid-stack-item-content">
            <div class="widget-header"><span class="widget-title">CRITICAL ALERTS</span><i class="fa-solid fa-grip-lines"></i></div>
            <div class="widget-body" style="padding:0;">
                <div class="status-card" onclick="openDeviceList('DOWN')">
                    <div><div class="val-huge blink-red">{{ down }}</div><div style="font-size:9px; color:#888;">OFFLINE (CLICK TO VIEW)</div></div>
                    <i class="fa-solid fa-triangle-exclamation" style="font-size:24px; color:#ff4757;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="6" gs-y="0" gs-w="6" gs-h="4">
        <div class="grid-stack-item-content">
            <div class="widget-header"><span class="widget-title">LIVE TRAFFIC FLOW</span><i class="fa-solid fa-grip-lines"></i></div>
            <div class="widget-body">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="0" gs-y="2" gs-w="6" gs-h="5">
        <div class="grid-stack-item-content">
            <div class="widget-header"><span class="widget-title"> >_ DIAGNOSTIC TERMINAL</span><i class="fa-solid fa-grip-lines"></i></div>
            <div class="widget-body" style="padding:0;">
                <div class="terminal-container">
                    <div class="term-controls">
                        <span style="color:#2ecc71; font-size:12px; padding-top:2px;">$</span>
                        <input type="text" id="pingIP" class="term-input" placeholder="Enter IP (e.g. 192.168.1.1)">
                        <button class="term-btn" onclick="startRealPing()" style="border-color:#2ecc71; color:#2ecc71;">▶ PING</button>
                        <button class="term-btn" onclick="stopRealPing()" style="border-color:#ff4757; color:#ff4757;">⏹ STOP</button>
                    </div>
                    <div id="termOutput" class="term-output">
                        <div style="color:#666;">// Console Initialized...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="6" gs-y="4" gs-w="6" gs-h="3">
        <div class="grid-stack-item-content">
            <div class="widget-header"><span class="widget-title">NETWORK MAP</span><i class="fa-solid fa-grip-lines"></i></div>
            <div class="widget-body" style="padding:0; background:#000;">
                <div id="mininetwork" style="width:100%; height:100%;"></div>
            </div>
        </div>
    </div>

</div>

<div id="listModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span id="modalTitle" class="modal-title">DEVICE LIST</span>
            <button onclick="closeModal()" class="modal-close"><i class="fa-solid fa-times"></i></button>
        </div>
        <div id="modalList" class="modal-body">
            </div>
    </div>
</div>

<script>
    // --- 0. DATA PREPARATION (From Jinja to JS) ---
    const allDevices = [
        {% for d in devices %}
        { name: "{{d.name}}", ip: "{{d.ip}}", state: "{{d.state}}", type: "{{d.device_type}}" },
        {% endfor %}
    ];

    // --- 1. POPUP LOGIC ---
    function openDeviceList(filterState) {
        const modal = document.getElementById('listModal');
        const listContainer = document.getElementById('modalList');
        const title = document.getElementById('modalTitle');

        // Clear previous
        listContainer.innerHTML = "";

        // Filter Data
        const filtered = allDevices.filter(d => d.state === filterState);

        title.innerText = (filterState === 'UP') ? `ACTIVE NODES (${filtered.length})` : `CRITICAL ALERTS (${filtered.length})`;
        title.style.color = (filterState === 'UP') ? '#2ecc71' : '#ff4757';

        if (filtered.length === 0) {
            listContainer.innerHTML = "<div style='padding:20px; text-align:center; color:#666;'>No devices found in this state.</div>";
        } else {
            filtered.forEach(d => {
                const color = (d.state === 'UP') ? '#2ecc71' : '#ff4757';
                const item = `
                    <div class="device-item">
                        <div style="display:flex; align-items:center;">
                            <span class="status-dot" style="background:${color}"></span>
                            <span style="font-weight:bold; margin-right:10px;">${d.name}</span>
                            <span style="color:#666;">[${d.type}]</span>
                        </div>
                        <span style="color:#00fff2;">${d.ip}</span>
                    </div>
                `;
                listContainer.innerHTML += item;
            });
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('listModal').style.display = 'none';
    }

    // --- 2. GRID INIT ---
    var grid = GridStack.init({ column: 12, cellHeight: 60, margin: 8, animate: true });
    function saveLayout() { alert("Layout Saved!"); }

    // --- 3. SMART GRAPH (LIVE SIMULATION) ---
    const ctx = document.getElementById('trafficChart').getContext('2d');

    // Initial Data
    const initialData = {
        labels: Array(10).fill(''),
        datasets: [{
            label: 'Traffic (Mb/s)',
            data: Array(10).fill(0),
            borderColor: '#00fff2',
            backgroundColor: 'rgba(0, 255, 242, 0.1)',
            fill: true, tension: 0.4
        }]
    };

    const smartChart = new Chart(ctx, {
        type: 'line',
        data: initialData,
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 0 }, // Disable animation for live performance
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { grid: { color: '#222' }, min: 0, max: 100 }
            }
        }
    });

    // Live Update Loop
    setInterval(() => {
        const data = smartChart.data.datasets[0].data;
        const labels = smartChart.data.labels;

        // Remove first
        data.shift();

        // Add new random value (Simulate Traffic)
        const val = Math.floor(Math.random() * 60) + 20;
        data.push(val);

        smartChart.update();
    }, 1000);

    // --- 4. REAL PING & SOCKET ---
    const socket = io();
    const outputDiv = document.getElementById('termOutput');

    function startRealPing() {
        const ip = document.getElementById('pingIP').value;
        if(!ip) return;
        outputDiv.innerHTML += `<div class="line-info" style="color:#f1c40f;">> Pinging ${ip}...</div>`;
        socket.emit('start_ping', { ip: ip });
    }
    function stopRealPing() { socket.emit('stop_ping'); }

    socket.on('ping_output', function(data) {
        const line = data.line;
        let color = '#ccc';
        if (line.includes('Reply')) color = '#2ecc71';
        else if (line.includes('out') || line.includes('error')) color = '#ff4757';

        const div = document.createElement('div');
        div.style.color = color;
        div.innerText = line;
        outputDiv.appendChild(div);
        outputDiv.scrollTop = outputDiv.scrollHeight;
    });

    // --- 5. TOPOLOGY MAP ---
    function loadMap() {
        fetch('/api/topology').then(r => r.json()).then(data => {
            var container = document.getElementById('mininetwork');
            var options = {
                nodes: { shape: 'dot', size: 12, font: { color: '#fff', size:10 }, borderWidth: 1 },
                edges: { color: '#005555', width: 1 },
                groups: { SWITCH: { shape: 'icon', icon: { face: "'Font Awesome 6 Free'", code: '\uf6ff', size: 20, color: '#00fff2' } } }
            };
            new vis.Network(container, data, options);
        });
    }
    setTimeout(loadMap, 500);

    // --- 6. BACKGROUND ---
    particlesJS("topology-bg", {
        "particles": { "number": { "value": 50 }, "color": { "value": "#00fff2" }, "opacity": { "value": 0.2 }, "size": { "value": 2 }, "line_linked": { "enable": true, "color": "#00fff2", "opacity": 0.1 } }
    });

</script>

{% endblock %}