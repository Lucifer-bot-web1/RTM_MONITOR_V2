{% extends "base.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
<link href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* --- THEME: DIGITAL FIBER (Dark Navy & Data) --- */
    :root {
        --bg-core: #0b1021;
        --bg-panel: rgba(13, 17, 34, 0.85);
        --border-color: rgba(64, 112, 244, 0.3);
        --accent-cyan: #00f2ff;
        --accent-blue: #4070f4;
        --text-mono: 'JetBrains Mono', 'Courier New', monospace;
    }

    body {
        background-color: var(--bg-core);
        background-image:
            radial-gradient(circle at 50% 50%, rgba(64, 112, 244, 0.05) 0%, transparent 50%),
            linear-gradient(0deg, rgba(255,255,255,0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
        background-size: 100% 100%, 40px 40px, 40px 40px;
        color: #e0e6ed;
        font-family: 'Roboto', sans-serif;
    }

    /* --- GRIDSTACK (DRAGGABLE WIDGETS) --- */
    .grid-stack-item-content {
        background: var(--bg-panel);
        border: 1px solid var(--border-color);
        backdrop-filter: blur(10px);
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Glowing Top Border for Professional Look */
    .grid-stack-item-content::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
        background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
        opacity: 0.7;
    }

    /* WIDGET HEADER (Drag Handle) */
    .widget-header {
        padding: 10px 15px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        cursor: grab; /* Shows it's draggable */
        user-select: none;
    }
    .widget-header:active { cursor: grabbing; }

    .widget-title {
        font-family: var(--text-mono);
        font-size: 12px; font-weight: bold; color: var(--accent-cyan);
        text-transform: uppercase; letter-spacing: 1px;
    }

    .widget-body {
        flex: 1; padding: 15px; overflow: auto; position: relative;
    }

    /* --- CUSTOM SCROLLBAR --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #050505; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-blue); }

    /* --- STATUS CARDS (Big Count) --- */
    .status-card {
        display: flex; align-items: center; justify-content: space-between; height: 100%;
    }
    .status-val { font-size: 36px; font-weight: bold; color: white; }
    .status-label { font-size: 10px; color: #888; text-transform: uppercase; margin-top: 5px; }
    .status-icon { font-size: 30px; opacity: 0.5; }

    /* Blink Animation for Down Devices */
    .blink-red { animation: blink 1.5s infinite; color: #ff4757; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* --- TERMINAL (PING TOOL) --- */
    .terminal-window {
        background: #000; width: 100%; height: 100%;
        font-family: var(--text-mono); font-size: 11px;
        padding: 10px; color: #ccc; overflow-y: auto;
        border: 1px solid #333;
    }
    .term-input-line { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .term-input {
        background: transparent; border: none; color: white;
        font-family: var(--text-mono); flex: 1; outline: none;
    }
    .term-btn {
        background: #222; border: 1px solid #444; color: white;
        padding: 2px 10px; font-size: 10px; cursor: pointer;
        font-family: var(--text-mono);
    }
    .term-btn:hover { background: var(--accent-blue); }
    .term-output { display: flex; flex-direction: column; gap: 2px; }
    .log-line-success { color: #2ecc71; }
    .log-line-error { color: #ff4757; }

    /* --- LOGS TABLE --- */
    .log-table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: var(--text-mono); }
    .log-table th { text-align: left; color: #888; padding-bottom: 5px; border-bottom: 1px solid #333; }
    .log-table td { padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ccc; }
    .status-badge { padding: 2px 6px; border-radius: 2px; font-size: 9px; font-weight: bold; }
    .badge-up { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
    .badge-down { background: rgba(255, 71, 87, 0.2); color: #ff4757; }

</style>

<div style="padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05);">
    <div style="font-family: var(--text-mono); font-weight: bold; color: var(--accent-cyan);">
        <i class="fa-solid fa-network-wired"></i> RTM OPERATIONS CENTER
    </div>
    <div>
        <button onclick="saveLayout()" class="term-btn"><i class="fa-solid fa-save"></i> SAVE LAYOUT</button>
        <button onclick="location.reload()" class="term-btn"><i class="fa-solid fa-sync"></i> SYNC</button>
    </div>
</div>

<div class="grid-stack">

    <div class="grid-stack-item" gs-x="0" gs-y="0" gs-w="3" gs-h="2">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span class="widget-title">ACTIVE NODES</span>
                <i class="fa-solid fa-grip-lines" style="color:#555;"></i>
            </div>
            <div class="widget-body">
                <div class="status-card">
                    <div>
                        <div class="status-val" style="color:#2ecc71;">{{ up }}</div>
                        <div class="status-label">OPERATIONAL</div>
                    </div>
                    <i class="fa-solid fa-wifi status-icon" style="color:#2ecc71;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="3" gs-y="0" gs-w="3" gs-h="2">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span class="widget-title">CRITICAL ALERTS</span>
                <i class="fa-solid fa-grip-lines" style="color:#555;"></i>
            </div>
            <div class="widget-body">
                <div class="status-card">
                    <div>
                        <div class="status-val blink-red">{{ down }}</div>
                        <div class="status-label">OFFLINE / ERROR</div>
                    </div>
                    <i class="fa-solid fa-triangle-exclamation status-icon" style="color:#ff4757;"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="6" gs-y="0" gs-w="6" gs-h="4">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span class="widget-title">NETWORK TRAFFIC (I/O)</span>
                <i class="fa-solid fa-grip-lines" style="color:#555;"></i>
            </div>
            <div class="widget-body">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="0" gs-y="2" gs-w="6" gs-h="5">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span class="widget-title">>_ DIAGNOSTIC TERMINAL</span>
                <i class="fa-solid fa-grip-lines" style="color:#555;"></i>
            </div>
            <div class="widget-body" style="padding:0;">
                <div class="terminal-window">
                    <div class="term-input-line">
                        <span style="color:#2ecc71;">root@rtm:~#</span>
                        <input type="text" id="pingTarget" class="term-input" placeholder="ping 192.168.1.1" value="ping ">
                        <button class="term-btn" onclick="startPing()" style="color:#2ecc71;">▶ RUN</button>
                        <button class="term-btn" onclick="stopPing()" style="color:#ff4757;">⏹ KILL</button>
                    </div>
                    <div id="termOutput" class="term-output">
                        <div>RTM Console v2.5.0 initialized...</div>
                        <div>Ready for commands.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="6" gs-y="4" gs-w="6" gs-h="3">
        <div class="grid-stack-item-content">
            <div class="widget-header">
                <span class="widget-title">EVENT LOGS</span>
                <i class="fa-solid fa-grip-lines" style="color:#555;"></i>
            </div>
            <div class="widget-body">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>TIME</th>
                            <th>DEVICE</th>
                            <th>STATUS</th>
                            <th>MESSAGE</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>10:42:05</td>
                            <td>Switch-Core-01</td>
                            <td><span class="status-badge badge-up">UP</span></td>
                            <td>Connection restored</td>
                        </tr>
                        <tr>
                            <td>10:41:12</td>
                            <td>Server-DB-02</td>
                            <td><span class="status-badge badge-down">DOWN</span></td>
                            <td>Request timed out (Packets: 0)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. INIT GRIDSTACK (Draggable & Resizable) ---
    var grid = GridStack.init({
        column: 12,
        cellHeight: 70,
        margin: 10,
        animate: true,
        disableOneColumnMode: true, // Keep grid on mobile
        float: true
    });

    function saveLayout() {
        // Logic to save layout to LocalStorage or DB
        alert("Layout configuration saved locally.");
    }

    // --- 2. TRAFFIC CHART CONFIG ---
    const ctx = document.getElementById('trafficChart').getContext('2d');
    const trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['10:00', '10:05', '10:10', '10:15', '10:20', '10:25'],
            datasets: [{
                label: 'Inbound',
                data: [12, 19, 3, 5, 2, 30],
                borderColor: '#00f2ff',
                backgroundColor: 'rgba(0, 242, 255, 0.1)',
                fill: true, tension: 0.4
            }, {
                label: 'Outbound',
                data: [5, 12, 10, 8, 15, 10],
                borderColor: '#4070f4',
                borderDash: [5, 5],
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#888', font: {family: 'monospace'} } } },
            scales: {
                x: { grid: { color: '#222' }, ticks: { color: '#666' } },
                y: { grid: { color: '#222' }, ticks: { color: '#666' } }
            }
        }
    });

    // --- 3. TERMINAL SIMULATION (Front-end Logic) ---
    let pingInterval;

    function startPing() {
        const target = document.getElementById('pingTarget').value.replace('ping ', '');
        const output = document.getElementById('termOutput');

        if(!target) return;

        // Add Start Line
        const startLine = document.createElement('div');
        startLine.innerText = `> Pinging ${target} with 32 bytes of data:`;
        startLine.style.color = '#fff';
        output.appendChild(startLine);

        // Simulate Loop (Real logic needs Backend Socket.IO)
        pingInterval = setInterval(() => {
            const line = document.createElement('div');
            // Randomly simulate success or fail for demo
            if(Math.random() > 0.1) {
                const time = Math.floor(Math.random() * 10) + 1;
                line.innerText = `Reply from ${target}: bytes=32 time=${time}ms TTL=64`;
                line.classList.add('log-line-success');
            } else {
                line.innerText = `Request timed out.`;
                line.classList.add('log-line-error');
            }
            output.appendChild(line);

            // Auto Scroll
            const termWindow = document.querySelector('.terminal-window');
            termWindow.scrollTop = termWindow.scrollHeight;
        }, 1000);
    }

    function stopPing() {
        clearInterval(pingInterval);
        const output = document.getElementById('termOutput');
        const stopLine = document.createElement('div');
        stopLine.innerText = `> Process terminated by user.`;
        stopLine.style.color = '#ff9f43';
        output.appendChild(stopLine);
    }
</script>

{% endblock %}