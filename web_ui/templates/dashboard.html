{% extends "base.html" %}

{% block content %}
<div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div>
        <h1 class="page-title" style="margin:0; font-size:1.8rem;">Command Center</h1>
        <div style="color:var(--text-muted); font-size:0.9rem;">System Status: NOMINAL</div>
    </div>
    <div style="text-align:right;">
        <h2 style="margin:0; font-family:monospace; color:var(--accent);">{{ now.strftime('%H:%M:%S') }}</h2>
        <small style="color:var(--text-muted);">{{ now.strftime('%Y-%m-%d') }}</small>
    </div>
</div>

<div class="card" style="padding:0; overflow:hidden; border:1px solid var(--accent); margin-bottom:20px;">
    <div style="padding:10px 15px; background:rgba(59, 130, 246, 0.1); display:flex; justify-content:space-between; align-items:center;">
        <h4 style="margin:0; color:var(--accent);"><i class="fa-solid fa-network-wired"></i> Live Topology</h4>
        <button onclick="openMapModal()" class="btn btn-primary" style="padding:4px 10px; font-size:0.8rem;">
            <i class="fa-solid fa-expand"></i> Full Screen
        </button>
    </div>
    <div id="mininetwork" style="height:250px; background:#0b1120;"></div>
</div>

<div class="stats-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:20px;">
    <div class="card" style="text-align:center; padding:20px;">
        <div style="font-size:2rem; color:var(--accent);"><i class="fa-solid fa-layer-group"></i></div>
        <h3 style="margin:5px 0;">{{ total }}</h3>
        <p style="color:var(--text-muted); margin:0;">Total Nodes</p>
    </div>
    <div class="card" style="text-align:center; padding:20px;">
        <div style="font-size:2rem; color:#10b981;"><i class="fa-solid fa-signal"></i></div>
        <h3 style="margin:5px 0;">{{ up }}</h3>
        <p style="color:var(--text-muted); margin:0;">Online</p>
    </div>
    <div class="card" style="text-align:center; padding:20px;">
        <div style="font-size:2rem; color:#ef4444;"><i class="fa-solid fa-ban"></i></div>
        <h3 style="margin:5px 0;">{{ down }}</h3>
        <p style="color:var(--text-muted); margin:0;">Offline</p>
    </div>
</div>

<div class="card">
    <table class="data-table" style="width:100%; border-collapse:collapse;">
        <thead>
            <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                <th style="padding:10px;">Status</th>
                <th style="padding:10px;">Name</th>
                <th style="padding:10px;">IP Address</th>
                <th style="padding:10px;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for d in devices %}
            <tr id="row_{{ d.ip.replace('.','_') }}" style="border-bottom:1px solid rgba(255,255,255,0.05);">
                <td style="padding:10px;"><span class="badge {{ d.state.lower() }}" style="padding:4px 8px; border-radius:4px; background:rgba(255,255,255,0.1);">{{ d.state }}</span></td>
                <td style="padding:10px;">{{ d.name }}</td>
                <td style="padding:10px; font-family:monospace; color:var(--accent);">{{ d.ip }}</td>
                <td style="padding:10px;"><button class="btn" style="padding:2px 8px; font-size:0.8rem;">Details</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="map-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; z-index:9000;">
    <button onclick="closeMapModal()" style="position:absolute; top:20px; right:20px; z-index:9001; background:#ef4444; border:none; color:white; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">
        CLOSE MAP [ESC]
    </button>
    <div id="fullnetwork" style="width:100%; height:100%;"></div>
</div>

<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
    function loadMap(containerId) {
        fetch('/api/topology')
        .then(response => response.json())
        .then(data => {
            var container = document.getElementById(containerId);
            var options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: { color: '#fff', face: 'monospace' },
                    borderWidth: 2
                },
                edges: {
                    color: '#64748b',
                    width: 2,
                    smooth: { type: 'continuous' }
                },
                physics: {
                    stabilization: false,
                    barnesHut: { gravitationalConstant: -8000 }
                },
                layout: { randomSeed: 2 }
            };
            new vis.Network(container, data, options);
        });
    }

    // Load Mini Map on Start
    loadMap('mininetwork');

    function openMapModal() {
        document.getElementById('map-modal').style.display = 'block';
        loadMap('fullnetwork');
    }

    function closeMapModal() {
        document.getElementById('map-modal').style.display = 'none';
    }
</script>
{% endblock %}