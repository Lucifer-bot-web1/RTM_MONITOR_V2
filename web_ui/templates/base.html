<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTM Pro | JARVIS Core</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div style="text-align:center; padding:10px; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1);">
                <h2 style="color:var(--accent); letter-spacing:2px; margin:0;">JARVIS</h2>
                <small style="color:var(--text-muted);">NET-SEC V2.0</small>
            </div>

            <nav>
                <a href="{{ url_for('main.dashboard') }}" class="menu-item"><i class="fa-solid fa-chart-line"></i> Overview</a>
                <a href="{{ url_for('main.devices') }}" class="menu-item"><i class="fa-solid fa-server"></i> Assets</a>
                <a href="{{ url_for('main.terminal') }}" class="menu-item"><i class="fa-solid fa-terminal"></i> SSH Console</a>
                <a href="{{ url_for('main.settings') }}" class="menu-item"><i class="fa-solid fa-gears"></i> Config</a>
            </nav>

            <div style="margin-top:auto;">
                <button onclick="toggleLogs()" class="btn" style="width:100%; margin-bottom:10px; background:#334155;">
                    <i class="fa-solid fa-list-ul"></i> Live Logs
                </button>
                <a href="{{ url_for('main.logout') }}" class="btn btn-danger" style="width:100%; display:block; text-align:center;">
                    <i class="fa-solid fa-power-off"></i> Disconnect
                </a>
            </div>
        </aside>

        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {{ category }}" style="padding:15px; margin-bottom:20px; border-radius:6px; background:rgba(0,0,0,0.3); border-left:4px solid var(--accent);">
                            <i class="fa-solid fa-info-circle"></i> {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="log-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; backdrop-filter:blur(5px);">
        <div style="width:80%; height:80%; margin:5% auto; background:#0f172a; border:1px solid #3b82f6; border-radius:10px; padding:20px; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h3 style="color:#22c55e; margin:0;">SYSTEM LOGS // REAL-TIME</h3>
                <button onclick="toggleLogs()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="log-content" style="flex:1; overflow-y:auto; font-family:monospace; color:#ccc;">
                <div>[SYSTEM] JARVIS Interface Connected...</div>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL HOTKEYS
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                // Logic: Close Logs -> Close Map -> Go Back
                const logs = document.getElementById('log-overlay');
                const mapModal = document.getElementById('map-modal'); // Defined in Dashboard

                if (logs && logs.style.display !== 'none') {
                    toggleLogs();
                } else if (mapModal && mapModal.style.display !== 'none') {
                    closeMapModal();
                } else {
                    window.history.back();
                }
            }
        });

        function toggleLogs() {
            const el = document.getElementById('log-overlay');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        // Connect Socket for Logs
        const socket = io();
        socket.on('connect', () => { console.log("Socket Connected"); });

        // Simulating logs based on events
        socket.on('device_update', (data) => {
            addLog(`[UPDATE] ${data.ip} is now ${data.state} (${data.rtt}ms)`);
        });

        socket.on('alert', (data) => {
            addLog(`[ALERT] ${data.msg}`);
        });

        function addLog(msg) {
            const box = document.getElementById('log-content');
            const line = document.createElement('div');
            line.innerText = `${new Date().toLocaleTimeString()} > ${msg}`;
            line.style.borderBottom = "1px solid #1e293b";
            line.style.padding = "4px 0";
            box.prepend(line); // Add to top
        }
    </script>
</body>
</html>